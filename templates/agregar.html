<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Agregar Servicio</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{
      --bg:#0B2147;
      --card:#143b71cf;
      --accent:#ffcc33;
      --text-dark:#082a65;
      --white:#ffffff;
    }

    html,body{
      height:100%;
      margin:0;
      font-family:"Verdana", Geneva, Tahoma, sans-serif;
      background:var(--bg);
      color:#fff;
      overflow:hidden;
    }

    .page-wrap{
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:1rem;
    }

    .service-card{
      width:100%;
      max-width:430px;
      background:var(--card);
      border-radius:20px;
      padding:1.25rem;
      box-shadow:0 8px 30px rgba(0,0,0,0.45);
      animation:slideIn .6s ease;
      height:90vh;
      display:flex;
      flex-direction:column;
      overflow-y:auto;
    }

    @keyframes slideIn{
      from{opacity:0; transform:translateY(20px)}
      to{opacity:1; transform:translateY(0)}
    }

    .service-card::-webkit-scrollbar{
      width: 7px;
    }

    .service-card::-webkit-scrollbar-thumb{
      background: var(--accent);
      border-radius: 20px;
    }

    .back-btn {
      background: var(--accent);
      border: none;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      box-shadow: 0 6px 18px rgba(254, 209, 48, 0.45);
      cursor: pointer;
      margin-bottom: 0.6rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .back-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 24px rgba(254, 209, 48, 0.55);
    }

    .back-btn img {
      width: 20px;
      height: 20px;
      object-fit: contain;
    }

    .titulo{margin-top:.5rem;margin-bottom:1rem}
    .titulo h3{font-weight:800;color:var(--white);margin:0}

    .register-card{
      background:var(--white);
      color:var(--text-dark);
      border-radius:14px;
      padding:1rem;
      box-shadow:0 8px 24px rgba(0,0,0,0.08);
    }

    .form-control,
    .select2-container--default .select2-selection--single {
      height:42px !important;
      border-radius:12px !important;
      padding:6px 12px !important;
      font-size:.95rem !important;
      border:1px solid #dfe6f1 !important;
      background:#fbfdff !important;
      display:flex !important;
      align-items:center !important;
    }

    .form-control:focus,
    .select2-selection--single:focus{
      box-shadow:0 0 0 3px rgba(255,204,51,0.45) !important;
      border-color:var(--accent) !important;
    }

    label{font-weight:600;font-size:.95rem}

    .valor-wrap { display:flex; gap:.5rem; align-items:center; }
    .valor-wrap .currency { font-weight:700; font-size:1rem; color:var(--text-dark) }

    .btn-service{
      background:var(--accent);
      color:var(--text-dark);
      font-weight:700;
      border-radius:12px;
      padding:.65rem 1rem;
      border:0;
      width:100%;
      box-shadow:0 8px 28px rgba(255,204,51,0.25);
    }

    .btn-service:hover{
      transform:translateY(-3px);
      opacity:.97;
    }

    .swal2-popup {
      border-radius:20px !important;
      background:#143b71 !important;
      color:#fff !important;
      box-shadow:0 0 25px rgba(254,209,48,0.4) !important;
      width:360px !important;
      padding:1.8rem !important;
    }

    .swal2-confirm{
      background:#fed130 !important;
      color:#082a65 !important;
      border-radius:10px !important;
      font-weight:700 !important;
    }

    .swal2-container.swal-centered {
      align-items:center !important;
      justify-content:center !important;
    }

    .select2-results__options::-webkit-scrollbar {
      width: 3px !important;
    }

  </style>
</head>
<body>

  <div class="page-wrap">
    <div class="service-card" id="serviceCard">

      <button class="back-btn" id="backButton">
        <img src="https://cdn-icons-png.flaticon.com/512/271/271220.png">
      </button>

      <div class="titulo">
        <h3 id="formTitle">¿Qué servicio <br/> deseas agregar hoy?</h3>
      </div>

      <div class="register-card">
        <form id="serviceForm">

          <div class="mb-2">
            <label for="Tipos">Tipo de servicio</label>
            <select id="Tipos" class="form-select" required>
                <option value="" disabled selected>Seleccionar</option>
                <option value="Apertura de automóvil">Apertura de automóvil</option>
                <option value="Apertura de caja fuerte">Apertura de caja fuerte</option>
                <option value="Apertura de candado">Apertura de candado</option>
                <option value="Apertura de motocicleta">Apertura de motocicleta</option>
                <option value="Apertura de puerta residencial">Apertura de puerta residencial</option>
                <option value="Cambio de clave de automóvil">Cambio de clave de automóvil</option>
                <option value="Cambio de clave de motocicleta">Cambio de clave de motocicleta</option>
                <option value="Cambio de clave residencial">Cambio de clave residencial</option>
                <option value="Duplicado de llave">Duplicado de llave</option>
                <option value="Elaboración de llaves">Elaboración de llaves</option>
                <option value="Instalación de alarma">Instalación de alarma</option>
                <option value="Instalación de chapa">Instalación de chapa</option>
                <option value="Reparación general">Reparación general</option>
            </select>
          </div>

          <div class="mb-2">
            <label for="nombreCliente">Nombre del cliente</label>
            <input type="text" id="nombreCliente" class="form-control" required>
          </div>

          <div class="mb-2">
            <label for="telefonoCliente">Teléfono del cliente</label>
            <input type="text" id="telefonoCliente" class="form-control" required pattern="[0-9]{7,13}" title="Ingresa un teléfono válido (7-13 dígitos)">
          </div>

          <div class="mb-2">
            <label for="direccion">Dirección</label>
            <input type="text" id="direccion" class="form-control" required>
          </div>

          <div class="mb-2">
            <label for="municipio">Municipio</label>
            <select id="municipio" class="form-select" required>
              <option value="" disabled selected>Seleccionar</option>
              <option value="Bucaramanga">Bucaramanga</option>
              <option value="Floridablanca">Floridablanca</option>
              <option value="Piedecuesta">Piedecuesta</option>
            </select>
          </div>

          <div class="row g-2">
            <div class="col-7 mb-2">
              <label for="fecha">Fecha</label>
              <input type="text" id="fecha" class="form-control datepicker" required>
            </div>
            <div class="col-5 mb-2">
              <label for="hora">Hora</label>
              <input type="text" id="hora" class="form-control" placeholder="Seleccionar hora" required>
            </div>
          </div>

          <div class="row g-2">
            <div class="col-7 mb-2">
                <label for="valor">Valor del servicio</label>
                <div class="valor-wrap">
                <span class="currency">$</span>
                <input type="text" id="valor" class="form-control" required>
                </div>
            </div>
            <div class="col-5 mb-2">
                <label for="metodoPago">Método Pago</label>
                <select id="metodoPago" class="form-select" required>
                    <option value="efectivo">Efectivo</option>
                    <option value="nequi">Nequi</option>
                </select>
            </div>
          </div>

          <div class="mb-2">
            <label for="cerrajero">Cerrajero</label>
            <select id="cerrajero" class="form-select" required>
              <option value="" disabled selected>Seleccionar</option>
              <option value="Jose Hernández">Jose Hernández</option>
              <option value="Otro">Otro</option>
            </select>
          </div>

          <div class="mb-2" id="otro-cerrajero-container" style="display:none">
            <div class="mb-2">
                <label for="otroCerrajero">Nombre del cerrajero</label>
                <input type="text" id="otroCerrajero" class="form-control">
            </div>
            <div class="mb-2">
                <label for="otroCerrajeroTelefono">Teléfono del cerrajero</label>
                <input type="text" id="otroCerrajeroTelefono" class="form-control" pattern="[0-9]+" title="Ingresa solo números">
            </div>
          </div>

          <div class="mb-2">
            <label for="estadoServicio">Estado</label>
            <select id="estadoServicio" class="form-select" required>
              <option value="" disabled selected>Seleccionar estado</option>
              <option value="pendiente">Pendiente</option>
              <option value="en proceso">En proceso</option>
              <option value="finalizado">Finalizado</option>
              <option value="cancelado">Cancelado</option>
            </select>
          </div>

          <button class="btn-service mt-3" type="submit" id="submitButton">Guardar Servicio</button>
        </form>
      </div>

    </div>
  </div>
  
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>

  <script>
    let editId = null;

    // Inicializadores de plugins
    $('#Tipos, #municipio, #cerrajero, #estadoServicio, #metodoPago').select2({
        minimumResultsForSearch: Infinity, width: '100%', dropdownParent: $('.register-card')
    });
    flatpickr(".datepicker", { locale: "es", dateFormat: "d/m/Y", disableMobile: true });
    flatpickr("#hora", { enableTime: true, noCalendar: true, dateFormat: "h:i K", minuteIncrement: 5, time_24hr: false, disableMobile: true });

    // Lógica para mostrar/ocultar campos de "Otro cerrajero"
    $('#cerrajero').on('change', function() {
        const container = $('#otro-cerrajero-container');
        if ($(this).val() === 'Otro') {
            container.slideDown(150).find('input').attr('required', true);
        } else {
            container.slideUp(120).find('input').removeAttr('required').val('');
        }
    });

    // Formateador de campo de valor monetario
    document.getElementById("valor").addEventListener("input", function (e) {
        let value = e.target.value.replace(/\D/g, "");
        e.target.value = new Intl.NumberFormat("es-CO").format(value);
    });

    // --- LÓGICA DEL BOTÓN DE REGRESAR (CORREGIDA) ---
    document.getElementById("backButton").addEventListener('click', () => {
        // La lógica se determina por si estamos en modo de edición o no.
        const currentEditId = localStorage.getItem("servicioEditarId");
        
        // Limpiar localStorage en cualquier caso antes de navegar
        localStorage.removeItem("servicioEditarId");

        if (currentEditId) {
            // Si existía un ID de edición, veníamos de la página de servicios.
            window.location.href = "{{ url_for('show_servicios_page') }}";
        } else {
            // Si no existía, veníamos de la página de inicio.
            window.location.href = "{{ url_for('inicio_page') }}";
        }
    });

    // --- LÓGICA PRINCIPAL AL CARGAR LA PÁGINA ---
    document.addEventListener('DOMContentLoaded', async () => {
        editId = localStorage.getItem('servicioEditarId');
        if (editId) {
            document.querySelector('#formTitle').innerHTML = 'Actualizar <br/> Servicio';
            document.querySelector('#submitButton').textContent = 'Actualizar Servicio';
            await loadServiceForEdit(editId);
        } else {
            const now = new Date();
            $('#fecha').val(now.toLocaleDateString('es-CO', {day:'2-digit', month:'2-digit', year:'numeric'}));
            $('#hora').val(now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }));
        }
    });

    async function loadServiceForEdit(id) {
        try {
            const response = await fetch(`/api/servicios/${id}`);
            if (!response.ok) throw new Error('No se pudo cargar la información del servicio.');
            const data = await response.json();

            $('#Tipos').val(data.tipo_s).trigger('change');
            $('#nombreCliente').val(data.nombre_c);
            $('#telefonoCliente').val(data.telefono_c);
            $('#direccion').val(data.direccion_c);
            $('#municipio').val(data.ciudad_c).trigger('change');
            $('#fecha').val(data.fecha_s);
            $('#hora').val(data.hora_s);
            $('#valor').val(new Intl.NumberFormat("es-CO").format(data.monto_pago));
            $('#metodoPago').val(data.metodo_pago).trigger('change');
            $('#cerrajero').val(data.nombre_ce).trigger('change');
            $('#estadoServicio').val(data.estado_s).trigger('change');

        } catch (error) {
            console.error("Error al cargar datos para editar:", error);
            Swal.fire({ icon: 'error', title: 'Error', text: error.message, background: '#143b71', color: '#fff', confirmButtonColor: '#fed130' });
        }
    }

    // --- FUNCIÓN PARA MANEJAR EL ENVÍO DEL FORMULARIO ---
    document.getElementById('serviceForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const datos = {
            tipo: $('#Tipos').val(),
            cliente: $('#nombreCliente').val().trim(),
            telefono_cliente: $('#telefonoCliente').val().trim(),
            direccion: $('#direccion').val().trim(),
            municipio: $('#municipio').val(),
            fecha: $('#fecha').val().trim(),
            hora: $('#hora').val().trim(),
            valor: $('#valor').val().trim().replace(/\./g, ''),
            metodo_pago: $('#metodoPago').val(),
            cerrajero: $('#cerrajero').val(),
            otroCerrajero: $('#otroCerrajero').val().trim(),
            otroCerrajeroTelefono: $('#otroCerrajeroTelefono').val().trim(),
            estado: $('#estadoServicio').val(),
        };
        
        const url = editId ? `/api/servicios/${editId}` : "{{ url_for('add_new_service') }}";
        const method = editId ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datos)
            });
            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.detalle || 'Error del servidor');
            }

            if (editId) {
                localStorage.removeItem('servicioEditarId');
            }

            Swal.fire({
                icon: 'success',
                title: `¡Servicio ${editId ? 'actualizado' : 'guardado'}!`,
                text: 'Los datos se han guardado correctamente.',
                background: '#143b71', color: '#fff', confirmButtonColor: '#fed130'
            }).then(() => {
                window.location.href = "{{ url_for('show_servicios_page') }}";
            });

        } catch (error) {
            console.error('Error al guardar:', error);
            Swal.fire({ icon: 'error', title: 'Error de Envío', text: error.message, background: '#143b71', color: '#fff', confirmButtonColor: '#fed130' });
        }
    });

  </script>

</body>
</html>
