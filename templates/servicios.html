<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ver Servicios - Cerrajería 24 Horas</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root {
      --bg: #0B2147;
      --card: #143b71cf;
      --accent: #ffcc33;
      --text-dark: #082a65;
      --white: #ffffff;
      --cancelado: #ff4b4b;
      --finalizado: #5ee072;
      --pendiente: #ffcc33;
      --en-proceso: #a29bfe; /* Nuevo color para 'en proceso' */
    }

    body {
      background-color: var(--bg);
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: 40px;
      margin: 0;
      font-family: Verdana, Geneva, Tahoma, sans-serif;
      overflow: hidden;
    }

    .service-card {
      background-color: var(--card);
      border-radius: 20px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.35);
      width: 100%;
      max-width: 430px;
      height: 90vh;
      padding: 1.8rem;
      overflow-y: auto;
      position: relative;
      animation: fadeIn 0.6s ease;
    }

    .service-card::-webkit-scrollbar { width: 8px; }
    .service-card::-webkit-scrollbar-thumb {
      background-color: var(--accent);
      border-radius: 20px;
      border: 2px solid var(--card);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .back-btn {
      background: var(--accent);
      position: absolute;
      top: 15px;
      left: 15px;
      border: none;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 18px rgba(254, 209, 48, 0.45);
      cursor: pointer;
      transition: 0.2s;
    }

    .back-btn:hover { transform: translateY(-2px); }
    .back-btn img { width: 20px; height: 20px; }

    .texto h3 {
      font-weight: 900;
      font-size: 1.45rem;
      text-align: center;
      color: #fff;
      margin-top: 70px;
      margin-bottom: 20px;
    }

    .btn-top {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      gap: 10px;
    }

    .btn-action {
      flex: 1;
      background-color: var(--accent);
      border: none;
      color: var(--text-dark);
      font-weight: 700;
      border-radius: 12px;
      padding: 10px;
      transition: 0.2s;
    }

    .btn-action:hover {
      background-color: #e5b800;
      transform: translateY(-2px);
    }

    .service-item {
      background-color: #dfeaef;
      color: var(--text-dark);
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 0 15px rgba(255, 204, 51, 0.25);
      cursor: pointer;
      transition: 0.2s;
    }

    .service-item.selected { border: 3px solid var(--accent); }

    .estado-chip {
      padding: 4px 10px;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 700;
      border: none;
      cursor: pointer;
      transition: 0.2s;
      text-transform: capitalize;
    }

    .estado-pendiente { background: var(--pendiente); color: var(--text-dark); }
    .estado-en-proceso { background: var(--en-proceso); color: var(--text-dark); }
    .estado-finalizado { background: var(--finalizado); color: var(--text-dark); }
    .estado-cancelado { background: var(--cancelado); color: #fff; }

    .no-data {
      text-align: center;
      margin-top: 20px;
      color: #ccc;
      font-size: 0.9rem;
    }
    
    .swal2-popup.swal2-custom {
        border-radius: 20px !important;
        box-shadow: 0 0 28px rgba(255, 204, 51, 0.45) !important;
    }
  </style>
</head>

<body>

  <div class="service-card">

    <button class="back-btn" onclick="location.href='{{ url_for('inicio_page') }}'">
      <img src="https://cdn-icons-png.flaticon.com/512/271/271220.png">
    </button>

    <div class="texto">
      <h3><b>Historial de servicios</b></h3>
    </div>

    <div class="btn-top">
      <button class="btn-action" onclick="editarServicio()">Editar</button>
      <button class="btn-action" onclick="eliminarServicio()">Eliminar</button>
    </div>

    <div id="listaServicios"></div>
    <div id="noServicios" class="no-data">No hay servicios registrados aún.</div>

  </div>

  <script>
    let servicioSeleccionado = null;

    document.addEventListener("DOMContentLoaded", () => {
      cargarServicios();
    });

    async function cargarServicios() {
      try {
        const response = await fetch("{{ url_for('get_all_servicios') }}");
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const servicios = await response.json();
        mostrarServicios(servicios);
      } catch (error) {
        console.error("Error al cargar servicios:", error);
        swalAjustado({ icon: "error", title: "Error de red", text: "No se pudieron cargar los servicios.", background: "#143b71", color: "#fff", confirmButtonColor: "#fed130" });
      }
    }

    function mostrarServicios(lista) {
      const contenedor = document.getElementById("listaServicios");
      const vacio = document.getElementById("noServicios");
      contenedor.innerHTML = "";

      vacio.style.display = lista.length === 0 ? "block" : "none";

      lista.forEach(serv => {
        const estadoClase = `estado-${serv.estado.replace(' ', '-')}`;
        const valorFormatted = new Intl.NumberFormat('es-CO').format(serv.valor);
        const metodoPagoCapitalizado = serv.metodo_pago.charAt(0).toUpperCase() + serv.metodo_pago.slice(1);
        let telefonoLimpio = serv.telefono_c;
        if (telefonoLimpio && telefonoLimpio.startsWith('57')) {
            telefonoLimpio = telefonoLimpio.substring(2);
        }

        const div = document.createElement("div");
        div.className = "service-item";
        div.dataset.id = serv.id_servicio;

        div.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <h5><b>${serv.tipo}</b></h5>
            <button class="estado-chip ${estadoClase}"
              onclick="cambiarEstado(${serv.id_servicio}); event.stopPropagation();">
              ${serv.estado}
            </button>
          </div>
          <p><b>Cliente:</b> ${serv.cliente}</p>
          <p><b>Teléfono:</b> ${telefonoLimpio}</p>
          <p><b>Dirección:</b> ${serv.direccion}</p>
          <p><b>Municipio:</b> ${serv.municipio}</p>
          <div style="display:flex; gap:20px;">
            <p><b>Fecha:</b> ${serv.fecha}</p>
            <p><b>Hora:</b> ${serv.hora}</p>
          </div>
          <p><b>Valor:</b> $${valorFormatted} (${metodoPagoCapitalizado})</p>
          <p><b>Cerrajero:</b> ${serv.cerrajero}</p>
        `;

        div.onclick = () => seleccionarServicio(div, serv.id_servicio);
        contenedor.appendChild(div);
      });
    }

    function seleccionarServicio(el, id) {
      document.querySelectorAll(".service-item").forEach(i => i.classList.remove("selected"));
      el.classList.add("selected");
      servicioSeleccionado = id;
    }

    function cambiarEstado(id) {
      const estados = [
        { nombre: 'pendiente', color: '#ffcc33', bg: '#fff7d1', text: '#8a6a00' },
        { nombre: 'en proceso', color: '#a29bfe', bg: '#e8e6ff', text: '#2d3436' },
        { nombre: 'finalizado', color: '#5ee072', bg: '#e8ffe8', text: '#0d6b2e' },
        { nombre: 'cancelado', color: '#ff4b4b', bg: '#ffe8e8', text: '#a80000' }
      ];

      const botonesHtml = estados.map(estado => `
        <button onclick="guardarNuevoEstado(${id}, '${estado.nombre}')"
          style="background:${estado.bg}; color:${estado.text}; border:2px solid ${estado.color}; font-weight:700; padding:10px; border-radius:12px; transition:.2s; text-transform: capitalize;"
          onmouseover="this.style.filter='brightness(1.1)'" onmouseout="this.style.filter='brightness(1)'">
          ${estado.nombre}
        </button>
      `).join('');

      Swal.fire({
        title: "Cambiar estado", background: "rgba(20, 59, 113, 0.95)", color: "#fff", width: "430px",
        padding: "1.5rem", showConfirmButton: false, showCancelButton: true, cancelButtonText: "Cerrar",
        cancelButtonColor: "#ffcc33", html: `<div style="display:flex; flex-direction:column; gap:12px; width:100%;">
${botonesHtml}</div>`,
        customClass: { popup: 'swal2-custom' }
      });
    }

    async function guardarNuevoEstado(id, nuevoEstado) {
      try {
        const response = await fetch(`/api/servicios/update_status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id_servicio: id, nuevo_estado: nuevoEstado })
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result.detalle || 'Error en el servidor');
        
        Swal.close();
        cargarServicios();

        swalAjustado({ icon: "success", title: "Estado actualizado", background: "#143b71", color: "#fff", confirmButtonColor: "#fed130", timer: 1500 });
      } catch (error) {
        console.error("Error al guardar estado:", error);
        swalAjustado({ icon: "error", title: "Error", text: `No se pudo actualizar el estado: ${error.message}`, background: "#143b71", color: "#fff", confirmButtonColor: "#fed130" });
      }
    }

    function editarServicio() {
      if (!servicioSeleccionado) {
        return swalAjustado({ icon: "info", title: "Selecciona un servicio", background: "#143b71", color: "#fff", confirmButtonColor: "#fed130" });
      }
      localStorage.setItem("servicioEditarId", servicioSeleccionado);
      window.location.href = "{{ url_for('agregar_page') }}";
    }

    function eliminarServicio() {
      if (!servicioSeleccionado) {
        return swalAjustado({ icon: "info", title: "Selecciona un servicio", background: "#143b71", color: "#fff", confirmButtonColor: "#fed130" });
      }

      swalAjustado({
        title: '¿Eliminar servicio?', text: "Esta acción no se puede deshacer.", icon: 'warning',
        showCancelButton: true, confirmButtonColor: "#e5b800", cancelButtonColor: "#3085d6",
        confirmButtonText: 'Sí, eliminar', cancelButtonText: 'Cancelar', background: "#143b71", color: "#fff"
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            const response = await fetch(`/api/servicios/${servicioSeleccionado}`, { method: 'DELETE' });
            const apiResult = await response.json();
            if (!response.ok) throw new Error(apiResult.detalle || 'Error en el servidor');
            
            servicioSeleccionado = null;
            cargarServicios();
            swalAjustado({ icon: "success", title: "Eliminado", text: "El servicio ha sido eliminado.", background: "#143b71", color: "#fff", confirmButtonColor: "#fed130", timer: 1500 });
          } catch (error) {
            console.error("Error al eliminar:", error);
            swalAjustado({ icon: "error", title: "Error", text: `No se pudo eliminar el servicio: ${error.message}`, background: "#143b71", color: "#fff", confirmButtonColor: "#fed130" });
          }
        }
      });
    }

    function swalAjustado(config) {
        // BUG FIX: Se añade "return" para que la promesa de Swal.fire se pueda encadenar con .then()
        return Swal.fire({ ...config, width: "430px", customClass: { popup: 'swal2-custom' } });
    }

  </script>

</body>
</html>
